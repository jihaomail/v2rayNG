name: Build Custom v2rayNG

# 触发条件：当推送到 main 或 master 分支时，或手动触发
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 第 1 步：检出代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'  # 递归克隆子模块
          fetch-depth: 0

      # 第 2 步：设置 JDK 17 环境
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 第 3 步：给 gradlew 添加执行权限
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        working-directory: ./V2rayNG

      - name: Download libv2ray.aar
        run: |
          mkdir -p app/libs
          curl -L "https://github.com/jihaomail/v2rayNG/releases/download/libv2ray-1/libv2ray.aar" -o app/libs/libv2ray.aar
          ls -lh app/libs/libv2ray.aar
        working-directory: ./V2rayNG

      # 第 4 步：编译 Release 版本的 APK
      - name: Build Release APK
        run: ./gradlew assembleDebug --stacktrace
        working-directory: ./V2rayNG
        env:
          GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4096m"

      - name: Collect APKs into flat folder
        run: |
          set -euxo pipefail
          cd "${{ github.workspace }}/V2rayNG"

          rm -rf out_apk
          mkdir -p out_apk

          # 把所有 release 的 APK 找出来复制到 out_apk（扁平化）
          find app/build/outputs/apk -type f -path "*/release/*.apk" -print

          # arm64-v8a
          a64="$(find app/build/outputs/apk -type f -path "*/release/*.apk" -iname "*arm64-v8a*.apk" | head -n 1 || true)"
          if [ -n "${a64}" ]; then
            cp -v "${a64}" "out_apk/v2rayng-arm64-v8a.apk"
          fi

          # armeabi-v7a
          v7="$(find app/build/outputs/apk -type f -path "*/release/*.apk" -iname "*armeabi-v7a*.apk" | head -n 1 || true)"
          if [ -n "${v7}" ]; then
            cp -v "${v7}" "out_apk/v2rayng-armeabi-v7a.apk"
          fi

          echo "== out_apk =="
          ls -lh out_apk

      - name: Verify output files exist
        run: |
          set -euxo pipefail
          test -f "${{ github.workspace }}/V2rayNG/out_apk/v2rayng-arm64-v8a.apk"
          test -f "${{ github.workspace }}/V2rayNG/out_apk/v2rayng-armeabi-v7a.apk"

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: apks
          path: ${{ github.workspace }}/V2rayNG/out_apk/*.apk
          retention-days: 30
          if-no-files-found: error



      # 第 7 步：显示编译摘要
      - name: Build Summary
        run: |
          echo "### Build Completed Successfully! ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**APK Location:** V2rayNG/app/build/outputs/apk/release/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the APK from the Artifacts section above." >> $GITHUB_STEP_SUMMARY
