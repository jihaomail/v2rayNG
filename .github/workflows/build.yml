name: Build Custom v2rayNG

# 触发条件：当推送到 main 或 master 分支时，或手动触发
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 第 1 步：检出代码
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'  # 递归克隆子模块
        fetch-depth: 0
    
    # 第 2 步：设置 JDK 17 环境
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    # 第 3 步：给 gradlew 添加执行权限
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      working-directory: ./V2rayNG
    
    # 第 4 步：编译 Release 版本的 APK
    - name: Build Release APK
      run: ./gradlew assembleRelease --stacktrace
      working-directory: ./V2rayNG
      env:
        GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4096m"
    
    # 第 5 步：重命名 APK 文件（添加时间戳）
    - name: Rename APK
      run: |
        cd V2rayNG/app/build/outputs/apk/release
        for file in *.apk; do
          new_name="v2rayNG-custom-$(date +%Y%m%d-%H%M%S).apk"
          mv "$file" "$new_name"
          echo "Renamed to: $new_name"
        done
    
    # 第 6 步：上传 APK 到 Artifacts（保存 30 天）
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: v2rayNG-custom-apk
        path: V2rayNG/app/build/outputs/apk/release/*.apk
        retention-days: 30
        if-no-files-found: error
    
    # 第 7 步：显示编译摘要
    - name: Build Summary
      run: |
        echo "### Build Completed Successfully! ✅" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**APK Location:** V2rayNG/app/build/outputs/apk/release/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download the APK from the Artifacts section above." >> $GITHUB_STEP_SUMMARY
